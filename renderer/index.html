<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="./index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body style="padding-top: 36px">
    <div class="titlebar">
      <div class="pin-toggle" onclick="togglePin()" title="ç½®é¡¶åˆ‡æ¢">
        <i id="pin-icon" class="fa-solid fa-thumbtack"></i>
      </div>
      <div class="window-controls">
        <div
          class="btn min"
          onclick="window.api.winControl('minimize')"
          data-tooltip="æœ€å°åŒ–"
        ></div>
        <div
          class="btn max"
          onclick="window.api.winControl('maximize')"
          data-tooltip="æœ€å¤§åŒ–"
        ></div>
        <div
          class="btn close"
          onclick="window.api.winControl('close')"
          data-tooltip="å…³é—­"
        ></div>
      </div>
    </div>

    <!-- æ·»åŠ ç”Ÿè¯é¡µ -->
    <div id="view-input" class="view">
      <div class="input-wrapper">
        <h2>æ·»åŠ ç”Ÿè¯</h2>
        <div class="form-group">
          <label for="en">è‹±æ–‡å•è¯</label>
          <input id="en" placeholder="å¦‚ï¼šapple" />
        </div>
        <div class="form-group">
          <label for="zh">ä¸­æ–‡é‡Šä¹‰</label>
          <input id="zh" placeholder="å¦‚ï¼šè‹¹æœ" />
        </div>
        <button id="saveBtn"><i class="fa fa-save"></i> ä¿å­˜è¯æ¡</button>
        <p
          id="error-msg"
          style="color: red; font-size: 14px; margin-top: 10px; display: none"
        ></p>
      </div>
    </div>

    <!-- å±•ç¤ºè¯æ±‡é¡µ -->
    <div id="view-display" class="view active">
      <h2>ç”Ÿè¯æœ¬</h2>
      <input id="search" placeholder="æœç´¢ä¸­/è‹±æ–‡" />
      <ul id="results"></ul>
      <div id="context-menu">
        <button onclick="deleteWord()">åˆ é™¤è¯æ¡</button>
        <button onclick="editWord()">ä¿®æ”¹è¯æ¡</button>
      </div>
    </div>

    <!-- è®¾ç½®é¡µ -->
    <div id="view-settings" class="view">
      <h2>è®¾ç½®</h2>
      <!-- å¯¼å…¥å¯¼å‡ºå¡ç‰‡ -->
      <div class="settings-card">
        <h3><i class="fa fa-file-csv"></i> å¯¼å…¥ / å¯¼å‡º CSV</h3>
        <div class="settings-buttons">
          <button onclick="exportCSV()">
            <i class="fa fa-download"></i> å¯¼å‡ºè¯åº“
          </button>
          <button onclick="importCSV()">
            <i class="fa fa-upload"></i> å¯¼å…¥è¯åº“
          </button>
        </div>
      </div>

      <!-- API åœ°å€å¡ç‰‡ -->
      <div class="settings-card">
        <h3><i class="fa fa-plug"></i> API åœ°å€</h3>

        <!-- è¾“å…¥æ¡† -->
        <input
          id="api-input"
          placeholder="https://example.com"
          style="margin-bottom: 12px; width: 100%; max-width: 420px"
        />

        <!-- ä¿å­˜æŒ‰é’® -->
        <button class="danger-button" id="api-save-btn">
          <i class="fa fa-save"></i> ä¿å­˜
        </button>

        <p style="font-size: 13px; color: #777; margin-top: 8px">
          ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼Œè‹¥è¯·æ±‚å¼‚å¸¸è¯·æ£€æŸ¥åœ°å€æ ¼å¼ã€‚
        </p>
        <h3><i class="fa fa-key"></i> è®¿é—®ä»¤ç‰Œï¼ˆTokenï¼‰</h3>
        <input
          id="token-input"
          placeholder="è¯·è¾“å…¥è®¿é—®ä»¤ç‰Œ"
          style="margin-bottom: 12px; width: 100%; max-width: 420px"
        />
        <button class="danger-button" id="token-save-btn">
          <i class="fa fa-save"></i> ä¿å­˜ Token
        </button>
        <p style="font-size: 13px; color: #777; margin-top: 8px">
          æ‰€æœ‰æ¥å£è¯·æ±‚å°†æºå¸¦æ­¤ä»¤ç‰Œè¿›è¡Œèº«ä»½æ ¡éªŒã€‚
        </p>
      </div>
      <!-- æ¸…ç©ºå•è¯æœ¬å¡ç‰‡ -->
      <div class="settings-card danger-card">
        <h3><i class="fa fa-trash"></i> æ¸…ç©ºå•è¯æœ¬</h3>
        <p style="margin-bottom: 10px; color: #b00020">
          æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œã€‚
        </p>
        <button onclick="clearAllWords()" class="danger-button">
          <i class="fa fa-trash"></i> ç«‹å³æ¸…ç©ºæ‰€æœ‰è¯æ¡
        </button>
      </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
      <button onclick="switchView('input')">
        <i class="fa-solid fa-plus"></i>
      </button>
      <button class="active" onclick="switchView('display')">
        <i class="fa-solid fa-list"></i>
      </button>
      <button onclick="switchView('settings')">
        <i class="fa-solid fa-gear"></i>
      </button>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <h3>ä¿®æ”¹è¯æ¡</h3>
        <p>è‹±æ–‡</p>
        <input id="edit-en" placeholder="è‹±æ–‡" />
        <p>ä¸­æ–‡</p>
        <input id="edit-zh" placeholder="ä¸­æ–‡" />
        <div class="modal-actions">
          <button onclick="confirmEdit()">ä¿å­˜</button>
          <button onclick="closeModal()">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    <!-- é€šç”¨æç¤ºæ¨¡æ€æ¡† -->
    <div id="custom-modal" class="modal">
      <div class="modal-content">
        <h3 id="modal-title">æç¤º</h3>
        <p id="modal-message"></p>
        <div class="modal-actions">
          <button id="modal-ok">ç¡®å®š</button>
          <button id="modal-cancel" style="display: none">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- JS è„šæœ¬ -->
    <script>
      let allWords = [];
      let selectedWord = null;

      function switchView(view) {
        document
          .querySelectorAll(".view")
          .forEach((div) => div.classList.remove("active"));
        document.querySelector(`#view-${view}`).classList.add("active");

        document
          .querySelectorAll(".bottom-nav button")
          .forEach((btn) => btn.classList.remove("active"));
        event.currentTarget.classList.add("active");

        if (view === "display") {
          loadWords();
          document.getElementById("search").value = "";
        }
      }

      async function saveWord() {
        const en = document.getElementById("en").value.trim();
        const zh = document.getElementById("zh").value.trim();
        const errorMsg = document.getElementById("error-msg");

        const isEnglish = /^[a-zA-Z\s\-]+$/.test(en);
        const isChinese = /^[\u4e00-\u9fa5\sÂ·ï¼Œã€‚ã€ï¼›ï¼šâ€œâ€â€˜â€™ï¼]+$/.test(zh);

        // æ¸…ç©ºä¹‹å‰é”™è¯¯æç¤º
        errorMsg.style.display = "none";
        errorMsg.textContent = "";

        if (!en || !zh) {
          errorMsg.textContent = "è¯·å¡«å†™å®Œæ•´çš„è‹±æ–‡å’Œä¸­æ–‡è¯æ¡ï¼";
          errorMsg.style.display = "block";
          return;
        }

        if (!isEnglish) {
          errorMsg.textContent = "è‹±æ–‡è¾“å…¥æ¡†åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€ç©ºæ ¼æˆ–è¿å­—ç¬¦ï¼";
          errorMsg.style.display = "block";
          return;
        }

        if (!isChinese) {
          errorMsg.textContent = "ä¸­æ–‡è¾“å…¥æ¡†åªèƒ½åŒ…å«ä¸­æ–‡å­—ç¬¦å’Œæ ‡ç‚¹ï¼";
          errorMsg.style.display = "block";
          return;
        }

        await window.api.saveWord({ en, zh });
        document.getElementById("en").value = "";
        document.getElementById("zh").value = "";
      }

      async function loadWords() {
        allWords = await window.api.getWords();
        renderList(allWords);
      }

      function renderList(words) {
        const list = document.getElementById("results");
        list.innerHTML = "";
        words.forEach((w) => {
          const li = document.createElement("li");
          li.className = "entry";
          li.innerHTML = `<span>${w.en}</span><span>${w.zh}</span>`;
          li.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            selectedWord = w;
            const menu = document.getElementById("context-menu");
            menu.style.top = `${e.pageY}px`;
            menu.style.left = `${e.pageX}px`;
            menu.style.display = "block";
          });
          list.appendChild(li);
        });
      }

      document.addEventListener("click", () => {
        document.getElementById("context-menu").style.display = "none";
      });

      document.getElementById("search").addEventListener("input", async (e) => {
        const kw = e.target.value.trim();
        if (!kw) return renderList(allWords);
        const filtered = await window.api.searchWord(kw);
        renderList(filtered);
      });

      function deleteWord() {
        if (selectedWord) {
          window.api.deleteWord(selectedWord.id).then(() => {
            loadWords();
            selectedWord = null;
          });
        }
      }

      function editWord() {
        if (selectedWord) {
          document.getElementById("edit-en").value = selectedWord.en;
          document.getElementById("edit-zh").value = selectedWord.zh;
          document.getElementById("edit-modal").style.display = "flex";
        }
      }

      function confirmEdit() {
        const newEn = document.getElementById("edit-en").value.trim();
        const newZh = document.getElementById("edit-zh").value.trim();
        if (newEn && newZh && selectedWord) {
          window.api
            .updateWord({ id: selectedWord.id, en: newEn, zh: newZh })
            .then(() => {
              loadWords();
              closeModal();
              selectedWord = null;
            });
        }
      }

      function closeModal() {
        document.getElementById("edit-modal").style.display = "none";
      }

      loadWords();
      document.getElementById("saveBtn").addEventListener("click", saveWord);

      let isPinned = false;

      async function togglePin() {
        isPinned = !isPinned;
        await window.api.setAlwaysOnTop(isPinned);

        const pin = document.querySelector(".pin-toggle");
        if (isPinned) {
          pin.classList.add("pinned");
        } else {
          pin.classList.remove("pinned");
        }
      }
      async function clearAllWords() {
        const confirmed = await showModal(
          "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å•è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼",
          { showCancel: true }
        );
        if (!confirmed) return;

        await window.api.clearWords();
        showModal("å·²æ¸…ç©ºï¼");
        loadWords(); // åˆ·æ–°é¡µé¢
      }

      function showModal(message, options = {}) {
        return new Promise((resolve) => {
          const modal = document.getElementById("custom-modal");
          const title = document.getElementById("modal-title");
          const msg = document.getElementById("modal-message");
          const okBtn = document.getElementById("modal-ok");
          const cancelBtn = document.getElementById("modal-cancel");

          title.textContent = options.title || "æç¤º";
          msg.textContent = message;
          okBtn.textContent = options.okText || "ç¡®å®š";
          cancelBtn.textContent = options.cancelText || "å–æ¶ˆ";

          // æ˜¾ç¤ºæˆ–éšè—å–æ¶ˆæŒ‰é’®
          if (options.showCancel) {
            cancelBtn.style.display = "inline-block";
          } else {
            cancelBtn.style.display = "none";
          }

          modal.style.display = "flex";

          okBtn.onclick = () => {
            modal.style.display = "none";
            resolve(true);
          };
          cancelBtn.onclick = () => {
            modal.style.display = "none";
            resolve(false);
          };
        });
      }
      document.addEventListener("DOMContentLoaded", () => {
        const apiInput = document.getElementById("api-input");
        const tokenInput = document.getElementById("token-input");
        const apiSaveBtn = document.getElementById("api-save-btn");
        const tokenSaveBtn = document.getElementById("token-save-btn");

        apiInput.value = localStorage.getItem("apiBase") || "";
        tokenInput.value = localStorage.getItem("apiToken") || "";

        apiSaveBtn.addEventListener("click", async () => {
          const val = apiInput.value.trim();
          localStorage.setItem("apiBase", val);
          await window.api.setApiBase(val);
          await showModal(`å·²ä¿å­˜ API åœ°å€ï¼š\n${val}`);
          loadWords();
        });

        tokenSaveBtn.addEventListener("click", async () => {
          const token = tokenInput.value.trim();

          if (token) {
            localStorage.setItem("apiToken", token);

            try {
              // å°è¯•è®¿é—® /words æ¥å£éªŒè¯ token
              await window.api.getWords();
              await showModal("âœ… Token å·²ä¿å­˜å¹¶éªŒè¯æˆåŠŸã€‚");
              window.location.reload(); // åˆ·æ–°ä»¥åº”ç”¨ token
            } catch (err) {
              // localStorage.removeItem("apiToken");
              await showModal("âŒ Token æ— æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥ï¼");
              window.location.reload();
            }
          } else {
            localStorage.removeItem("apiToken");
            tokenInput.value = "";
            await showModal("ğŸš« Token å·²æ¸…é™¤ï¼Œæ‰€æœ‰è¯·æ±‚å°†ä¸å†é‰´æƒ");
            window.location.reload();
          }
        });
      });
      async function exportCSV() {
        const msg = await window.api.exportCSV();
        showModal(msg || "å¯¼å‡ºå–æ¶ˆ");
      }

      async function importCSV() {
        const msg = await window.api.importCSV();
        showModal(msg || "å¯¼å…¥å–æ¶ˆ");
        loadWords(); // åˆ·æ–°åˆ—è¡¨
      }
    </script>
  </body>
</html>
